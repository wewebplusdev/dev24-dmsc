name: Auto Deploy
on:
  push:
    branches: [ main, staging, developer ]
  pull_request:
    branches: [ main, staging, developer ]
jobs:
#   sonarcloud:
#     name: SonarCloud
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
#         with:
#           fetch-depth: 1  # Shallow clones should be disabled for a better relevancy of analysis
#       - name: SonarCloud Scan
#         uses: SonarSource/sonarcloud-github-action@master
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  deploy:
    # needs: [ sonarcloud ]
    name: Auto Deploy
    runs-on: 
      - aws-dmsc-runner
    steps:
      - uses: actions/checkout@v2
      - run: |
          echo "Start Deploy..."
          sudo rm -rf /home/website/*
          sudo cp -r * /home/website/
          sudo rm -rf *
          echo "Starting Deploy webservice..."
          sudo cp -r /home/website/webservice /wwwroot
          echo "copy .env"
          sudo cp -r /home/env/.env /wwwroot/webservice/src
          echo "Starting Docker Image webservice"
          cd / 
          cd wwwroot/webservice
          docker compose down
          docker compose up --build -d
          echo "webservice is running..."

          echo "Starting Deploy website..."
          sudo cp -r /home/website /wwwroot
          sudo rm -rf /wwwroot/website/webservice
          echo "Starting Docker Image website"
          cd / 
          cd wwwroot/website
          docker compose down
          docker compose up --build -d
          echo "website is running..."

          echo "Deployment successfully..."
          sudo rm -rf /home/website/*
